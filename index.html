<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¹Ù„ÙˆÙ… | Ù…Ø¯Ø±Ø³Ø© Ø°Ø§Øª Ø§Ù„ØµÙˆØ§Ø±ÙŠ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --blue: #00f3ff; --purple: #bc13fe; --bg: #05070a; --green: #39ff14; --pink: #ff0055; }
        
        body, html { height: 100%; margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Cairo', sans-serif; overflow-x: hidden; display: flex; flex-direction: column; }
        
        /* Ø§Ù„ÙØ¶Ø§Ø¡ ÙˆØ§Ù„Ù†Ø¬ÙˆÙ… */
        .space-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1b2735 0%, #05070a 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle var(--duration) infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£Ø¨Ø®Ø±Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© */
        .steam { position: fixed; bottom: -50px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; filter: blur(20px); animation: rise 8s infinite ease-in; z-index: -1; }
        @keyframes rise { 0% { transform: translateY(0) scale(1); opacity: 0; } 50% { opacity: 0.3; } 100% { transform: translateY(-100vh) scale(3); opacity: 0; } }

        /* Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±) */
        .astro-css { position: absolute; width: 60px; height: 80px; top: 20%; right: 10%; animation: floatAstro 6s infinite ease-in-out; z-index: 2; }
        .astro-head { width: 30px; height: 30px; background: #fff; border-radius: 50%; position: relative; border: 2px solid #ddd; }
        .astro-visor { width: 20px; height: 10px; background: #333; border-radius: 4px; position: absolute; top: 8px; left: 5px; box-shadow: 0 0 10px var(--blue); }
        .astro-body { width: 40px; height: 45px; background: #eee; border-radius: 8px; margin-top: -5px; border: 2px solid #ddd; }
        @keyframes floatAstro { 0%, 100% { transform: translateY(0) rotate(5deg); } 50% { transform: translateY(-30px) rotate(-10deg); } }

        /* Ø¹Ù†ÙˆØ§Ù† SCIENCE LAB Ø§Ù„Ù…Ø¶ÙŠØ¡ */
        .glowing-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            color: #fff;
            text-shadow: 0 0 10px var(--blue), 0 0 20px var(--blue), 0 0 40px var(--blue);
            animation: glowPulse 2s infinite alternate;
            margin: 20px 0;
        }
        @keyframes glowPulse { from { opacity: 0.8; transform: scale(1); } to { opacity: 1; transform: scale(1.05); text-shadow: 0 0 20px var(--purple), 0 0 40px var(--purple); } }

        /* Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ */
        .orbit { position: absolute; border: 1px solid rgba(255,255,255,0.05); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .planet { position: absolute; border-radius: 50%; top: -10px; left: 50%; }
        .earth-orbit { width: 400px; height: 400px; animation: spin 20s linear infinite; }
        .earth-css { width: 25px; height: 25px; background: #2271B3; box-shadow: 0 0 15px var(--blue); }
        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        .school-header { text-align: center; padding: 15px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-bottom: 2px solid var(--blue); z-index: 10; }
        .main-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; z-index: 5; padding: 20px; }
        
        .card { background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); padding: 30px; border-radius: 30px; border: 1px solid var(--blue); text-align: center; box-shadow: 0 0 40px rgba(0, 243, 255, 0.2); max-width: 500px; width: 100%; }

        .btn { background: var(--purple); color: #fff; border: none; padding: 12px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 1.1rem; }
        .btn:hover { background: var(--blue); color: #000; transform: translateY(-3px); box-shadow: 0 5px 15px var(--blue); }

        .option { background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 15px; cursor: pointer; text-align: right; border: 1px solid transparent; transition: 0.2s; }
        .option:hover { background: rgba(0, 243, 255, 0.2); border-color: var(--blue); }
        .correct { background: var(--green) !important; color: #000; font-weight: bold; }
        .wrong { background: var(--pink) !important; color: #fff; }

        input[type="text"] { width: 90%; padding: 15px; border-radius: 15px; border: 2px solid var(--blue); background: #000; color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 20px; }
        #quiz-area, #tabs-container, #result-screen { display: none; }
        .question-img { max-width: 100%; border-radius: 15px; border: 2px solid var(--purple); margin: 10px 0; }
    </style>
</head>
<body>

<div class="space-bg" id="space">
    <div class="astro-css">
        <div class="astro-head"><div class="astro-visor"></div></div>
        <div class="astro-body"></div>
    </div>
    <div class="orbit earth-orbit"><div class="planet earth-css"></div></div>
</div>

<div class="school-header">
    <h2 id="ui-school-name" style="margin:0; color:var(--blue);">Ù…Ø¯Ø±Ø³Ø© Ø°Ø§Øª Ø§Ù„ØµÙˆØ§Ø±ÙŠ</h2>
    <p style="margin:5px 0; font-size:0.8rem;">Ø§Ù„Ù…Ø¹Ù„Ù…: <span id="ui-teacher-name" style="color:var(--green)">...</span></p>
</div>

<div class="main-wrapper">
    <div id="login-screen" class="card">
        <div class="glowing-title">SCIENCE LAB</div>
        <p style="color: #ccc;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„Ø§ÙƒØªØ´Ø§ÙØ§Øª</p>
        <input type="text" id="stdName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„">
        <br>
        <button class="btn" onclick="startApp()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ¨Ø± ğŸ§ª</button>
    </div>

    <div id="tabs-container" class="card">
        <h3 style="color: var(--blue);">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙƒØ´Ø§ÙÙ‡:</h3>
        <div id="tabs" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    </div>

    <div id="quiz-area" class="card">
        <div style="display:flex; justify-content: space-between; font-family: 'Orbitron';">
            <span id="timerText" style="color:var(--pink)">30s</span>
            <span id="qCounter"></span>
        </div>
        <img id="qImage" class="question-img" style="display:none;">
        <h2 id="qText" style="font-size: 1.2rem; margin:15px 0;"></h2>
        <div id="optionsContainer"></div>
    </div>

    <div id="result-screen" style="width:100%; max-width:600px;">
        <div id="photo-card" class="card" style="border-color: var(--green); max-width:none;">
            <h2 style="color: var(--green);">ğŸ‰ Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ù…Ø³ØªÙƒØ´Ù ğŸ‰</h2>
            <h3 id="finalName"></h3>
            <h4 id="finalLab" style="color: var(--blue);"></h4>
            <div id="finalScore" style="font-family:'Orbitron'; font-size:3rem; color:var(--purple); margin:10px 0;"></div>
            
            <div id="questions-report" style="display:none; background:#fff; color:#000; padding:15px; border-radius:15px; text-align:right;">
                <h4 style="text-align:center; border-bottom:1px solid #333;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©</h4>
                <div id="report-list"></div>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
            <button class="btn" style="background:var(--green); color:#000;" onclick="sendResult()">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
            <button class="btn" style="background:orange" onclick="saveFullReport()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button id="retryBtn" class="btn" style="background:none; border:1px solid #fff;" onclick="retryQuiz()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
            <button class="btn" style="background:none; border:1px solid var(--blue); color:var(--blue);" onclick="backToLabs()">ğŸ  Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª</button>
        </div>
    </div>
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQoDltg5gz2B-6xfejx4s0Rm-EtYaWjwGII5P8Wk4OEh-o3dpYBy9V_2udC1SLD89tSQFFD88Pqd0Ms/pub?gid=0&single=true&output=csv';
    const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSd6qV0wUZIOTA3maN-KuBBhzivjeF0lCYD37-Ecr4FErVu6Xw/formResponse';
    const ENTRY_NAME = 'entry.851707482', ENTRY_SCORE = 'entry.1149023992';

    let allQuestions = [], studentName = "", score = 0, currentLab = "";
    let timeLeft = 30, timerInterval, labSettings = {}, studentAnswers = [];

    window.onload = () => {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø£Ø¨Ø®Ø±Ø©
        const space = document.getElementById('space');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div'); s.className = 'star';
            s.style.width = s.style.height = Math.random()*2+'px';
            s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
            s.style.setProperty('--duration', Math.random()*3+2+'s');
            space.appendChild(s);
        }
        for(let i=0; i<8; i++) {
            const st = document.createElement('div'); st.className = 'steam';
            st.style.width = st.style.height = Math.random()*100+50+'px';
            st.style.left = Math.random()*100+'%'; st.style.animationDelay = Math.random()*5+'s';
            space.appendChild(st);
        }
        fetchData();
    };

    function fetchData() {
        Papa.parse(SHEET_CSV, { download: true, header: true, complete: (res) => {
            const d = res.data;
            if(d.length > 0) {
                document.getElementById('ui-school-name').innerText = d[0]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || "Ù…Ø¯Ø±Ø³Ø© Ø°Ø§Øª Ø§Ù„ØµÙˆØ§Ø±ÙŠ";
                document.getElementById('ui-teacher-name').innerText = d[0]['Ø§Ù„Ù…Ø¹Ù„Ù…'] || "Ø£. Ø±ÙŠØ§Ù† Ø§Ù„Ø§Ø³Ù…Ø±ÙŠ";
            }
            allQuestions = d.filter(q => q['Ø§Ù„Ù…Ø®ØªØ¨Ø±']).map(q => {
                labSettings[q['Ø§Ù„Ù…Ø®ØªØ¨Ø±']] = (q['Ø¥Ø¹Ø§Ø¯Ø©'] === "Ù†Ø¹Ù…");
                return { lab: q['Ø§Ù„Ù…Ø®ØªØ¨Ø±'], question: q['Ø§Ù„Ø³Ø¤Ø§Ù„'], correct: q['Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©'], wrong: q['Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'], image: q['Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©'] };
            });
            renderLabs();
        }});
    }

    function renderLabs() {
        const labs = [...new Set(allQuestions.map(q => q.lab))];
        const div = document.getElementById('tabs'); div.innerHTML = "";
        labs.forEach(l => { div.innerHTML += `<button class="btn" style="background:rgba(255,255,255,0.05); border:1px solid var(--blue);" onclick="startQuiz('${l}')">${l}</button>`; });
    }

    function startApp() {
        studentName = document.getElementById('stdName').value;
        if(!studentName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('tabs-container').style.display = 'block';
    }

    function startQuiz(lab) {
        currentLab = lab; score = 0; studentAnswers = [];
        document.getElementById('tabs-container').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';
        loadQuestion(0);
    }

    function loadQuestion(idx) {
        const qs = allQuestions.filter(q => q.lab === currentLab);
        if(idx >= qs.length) return showResult();
        document.getElementById('qCounter').innerText = `${idx+1} / ${qs.length}`;
        const q = qs[idx];
        document.getElementById('qText').innerText = q.question;
        const img = document.getElementById('qImage');
        if(q.image) { img.src = q.image; img.style.display = "block"; } else { img.style.display = "none"; }
        
        timeLeft = 30; updateTimer(); clearInterval(timerInterval);
        timerInterval = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft <= 0) { studentAnswers.push({q: q.question, a: "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª", c: false}); loadQuestion(idx+1); } }, 1000);

        const opts = [q.correct, q.wrong].sort(() => Math.random() - 0.5);
        const container = document.getElementById('optionsContainer'); container.innerHTML = "";
        opts.forEach(o => {
            const div = document.createElement('div'); div.className = 'option'; div.innerText = o;
            div.onclick = () => {
                clearInterval(timerInterval);
                const isOk = (o === q.correct);
                if(isOk) { div.classList.add('correct'); score++; } else { div.classList.add('wrong'); }
                studentAnswers.push({q: q.question, a: o, c: isOk});
                setTimeout(() => loadQuestion(idx+1), 600);
            };
            container.appendChild(div);
        });
    }

    function updateTimer() { document.getElementById('timerText').innerText = timeLeft + "s"; }

    function showResult() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('finalName').innerText = studentName;
        document.getElementById('finalLab').innerText = "Ù…Ù‡Ù…Ø©: " + currentLab;
        document.getElementById('finalScore').innerText = score + " XP";
        document.getElementById('retryBtn').style.display = labSettings[currentLab] ? "inline-flex" : "none";

        const list = document.getElementById('report-list'); list.innerHTML = "";
        studentAnswers.forEach((ans, i) => {
            list.innerHTML += `<div style="border-bottom:1px solid #ddd; padding:10px;"><b>Ø³${i+1}: ${ans.q}</b><br>Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${ans.a} ${ans.c?'âœ…':'âŒ'}</div>`;
        });
    }

    function sendResult() {
        const f = document.createElement('form'); f.method = 'POST'; f.action = FORM_URL; f.target = 'hidden_iframe';
        const n = document.createElement('input'); n.name = ENTRY_NAME; n.value = studentName;
        const s = document.createElement('input'); s.name = ENTRY_SCORE; s.value = score + " ÙÙŠ " + currentLab;
        f.appendChild(n); f.appendChild(s); document.body.appendChild(f); f.submit();
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬ØªÙƒ Ù„Ù„Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­!");
    }

    function saveFullReport() {
        const r = document.getElementById('questions-report'); r.style.display = "block";
        html2canvas(document.getElementById('photo-card'), {backgroundColor:'#05070a'}).then(canvas => {
            const link = document.createElement('a'); link.download = `ØªÙ‚Ø±ÙŠØ±_${studentName}.png`;
            link.href = canvas.toDataURL(); link.click(); r.style.display = "none";
        });
    }

    function backToLabs() { document.getElementById('result-screen').style.display = 'none'; document.getElementById('tabs-container').style.display = 'block'; }
    function retryQuiz() { startQuiz(currentLab); }
</script>
</body>
</html>
