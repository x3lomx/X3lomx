<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¹Ù„ÙˆÙ… | Ù…Ø¯Ø±Ø³Ø© Ø°Ø§Øª Ø§Ù„ØµÙˆØ§Ø±ÙŠ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --blue: #00f3ff; --purple: #bc13fe; --bg: #05070a; --green: #39ff14; --pink: #ff0055; }
        
        body, html { 
            height: 100%; margin: 0; padding: 0;
            background: var(--bg); color: #fff; font-family: 'Cairo', sans-serif; 
            overflow-x: hidden; display: flex; flex-direction: column;
        }

        .space-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
            overflow: hidden;
        }

        .star {
            position: absolute; background: white; border-radius: 50%;
            opacity: 0.5; animation: twinkle var(--duration) infinite;
        }

        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        #login-screen {
            position: relative; overflow: hidden;
            border: 2px solid var(--blue);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3), inset 0 0 15px rgba(0, 243, 255, 0.2);
            animation: borderGlow 4s infinite alternate;
        }

        @keyframes borderGlow {
            from { border-color: var(--blue); box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }
            to { border-color: var(--purple); box-shadow: 0 0 30px rgba(188, 19, 254, 0.4); }
        }

        .cyber-btn {
            position: relative; background: transparent !important;
            border: 2px solid var(--blue) !important; color: var(--blue) !important;
            overflow: hidden; z-index: 1;
        }
        .cyber-btn:hover { background: var(--blue) !important; color: #000 !important; box-shadow: 0 0 40px var(--blue); }

        .school-header { 
            text-align: center; padding: 30px 20px;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
            width: 100%; box-sizing: border-box;
        }
        .school-header h1 { color: var(--blue); margin: 0; font-size: clamp(1.4rem, 4vw, 2.2rem); text-shadow: 0 0 20px var(--blue); }
        .highlight { color: var(--green); font-weight: bold; }

        .main-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 15px; width: 100%; box-sizing: border-box; }
        .app-container { width: 100%; max-width: 750px; }

        .card { 
            background: rgba(255,255,255,0.05); backdrop-filter: blur(15px);
            padding: clamp(15px, 4vw, 35px); border-radius: 25px; 
            border: 1px solid rgba(0, 243, 255, 0.2); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            text-align: center;
        }

        /* ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© */
        .question-img { 
            max-width: 100%; 
            max-height: 220px; 
            border-radius: 12px; 
            margin: 0 auto 15px auto; /* Ø§Ù„ØªÙˆØ³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… margin auto */
            display: block; /* Ø¬Ø¹Ù„Ù‡Ø§ ÙƒØªÙ„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ³ÙŠØ· */
            border: 2px solid var(--purple); 
        }

        .btn { 
            background: var(--purple); color: #fff; border: none; 
            padding: 12px 25px; border-radius: 10px; cursor: pointer; 
            font-weight: bold; transition: 0.3s; font-size: 0.95rem;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--purple); }
        
        .btn-outline { background: transparent; border: 1px solid var(--blue); color: var(--blue); }

        input[type="text"] { padding: 15px; width: 85%; max-width: 350px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid var(--purple); border-radius: 12px; text-align: center; font-size: 1.1rem; margin-bottom: 20px; outline: none; }

        .option { background: rgba(255,255,255,0.08); padding: 15px; margin: 10px 0; border-radius: 12px; cursor: pointer; border: 1px solid transparent; text-align: right; transition: 0.2s; }
        .option:hover { background: rgba(0, 243, 255, 0.2); border-color: var(--blue); }
        .correct { background: var(--green) !important; color: #000; font-weight: bold; }
        .wrong { background: var(--pink) !important; color: #fff; }
        
        .timer-container { width: 100%; background: #111; height: 7px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .timer-bar { height: 100%; background: linear-gradient(90deg, var(--purple), var(--blue)); width: 100%; transition: 1s linear; }

        #result-screen, #quiz-area { display: none; }
        
        .send-status { background: rgba(57, 255, 20, 0.1); color: var(--green); padding: 15px; border-radius: 15px; margin: 20px 0; border: 1px solid var(--green); }

        .action-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
    </style>
</head>
<body>

<div class="space-bg" id="space"></div>

<div class="school-header">
    <h1 id="ui-school-name">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©...</h1>
    <div style="font-size: 0.9rem; margin-top:8px;">
        <span>Ø§Ù„Ù…Ø¯ÙŠØ±: <span class="highlight" id="ui-manager-name">...</span></span> | 
        <span>Ø§Ù„Ù…Ø¹Ù„Ù…: <span class="highlight" id="ui-teacher-name">...</span></span>
    </div>
</div>

<div class="main-wrapper">
    <div class="app-container">
        <div id="login-screen" class="card">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‘¨â€ğŸš€</div>
            <h2 style="color: var(--blue); margin-bottom: 25px;">Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h2>
            <input type="text" id="stdName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            <br>
            <button class="btn cyber-btn" onclick="startApp()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ğŸš€</button>
        </div>

        <div id="tabs-container" style="display:none; text-align:center;">
            <h3 style="color: var(--blue); margin-bottom: 15px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</h3>
            <div id="tabs" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:20px;"></div>
        </div>
        
        <div id="quiz-area" class="card">
            <div style="display:flex; justify-content: space-between; font-family: 'Orbitron';">
                <span id="timerText" style="color: var(--blue); font-size: 1.3rem;">30s</span>
                <span id="qCounter" style="color: var(--purple);"></span>
            </div>
            <div class="timer-container"><div id="timerBar" class="timer-bar"></div></div>
            
            <div style="text-align: center; width: 100%;">
                <img id="qImage" class="question-img" src="" style="display: none;">
            </div>
            
            <h2 id="qText" style="margin: 15px 0; font-size: 1.25rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <div id="optionsContainer"></div>
            <br>
            <button class="btn btn-outline" onclick="backToLabs()">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª</button>
        </div>

        <div id="result-screen">
            <div id="photo-card" class="card" style="margin-bottom: 10px; border-color: var(--green);">
                <h2 style="color: var(--green); margin-top: 0;">ğŸŒŸ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸŒŸ</h2>
                <h3 id="finalName" style="margin: 5px 0;"></h3>
                <h4 id="finalLab" style="color: var(--blue); margin: 5px 0;"></h4>
                <div id="finalScore" style="font-family:'Orbitron'; font-size:3.5rem; color:var(--purple); margin: 8px 0;"></div>
            </div>

            <div class="send-status">
                <p style="font-weight:bold; margin:0;">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„Ù…</p>
                <p style="font-size: 0.8rem; margin: 5px 0 0 0; opacity: 0.8;">Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø²Ø± Ø¥Ø¶Ø§ÙÙŠ.</p>
            </div>

            <div class="action-buttons">
                <button class="btn" style="background:var(--blue); color:#000;" onclick="takeScreenshot()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                <button class="btn" style="background:#25D366" onclick="goToWhatsApp()">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                <button class="btn" style="background:orange" onclick="retryQuiz()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button class="btn btn-outline" onclick="backToLabs()">ğŸ  Ù…Ø®ØªØ¨Ø± Ø¢Ø®Ø±</button>
            </div>
        </div>
    </div>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

<script>
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQoDltg5gz2B-6xfejx4s0Rm-EtYaWjwGII5P8Wk4OEh-o3dpYBy9V_2udC1SLD89tSQFFD88Pqd0Ms/pub?gid=0&single=true&output=csv'; 
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSd6qV0wUZIOTA3maN-KuBBhzivjeF0lCYD37-Ecr4FErVu6Xw/formResponse'; 
    const ENTRY_NAME = 'entry.851707482'; 
    const ENTRY_SCORE = 'entry.1149023992'; 

    let allQuestions = [], studentName = "", score = 0, currentLab = "";
    let timeLeft = 30, timerInterval;
    let teacherPhone = ""; // Ø³ÙŠØªÙ… Ø³Ø­Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ Ø¥Ø°Ø§ Ø±ØºØ¨Øª

    function createSpace() {
        const space = document.getElementById('space');
        for(let i=0; i<80; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = Math.random() * 2 + 'px';
            star.style.height = star.style.width;
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.setProperty('--duration', Math.random() * 3 + 2 + 's');
            space.appendChild(star);
        }
    }
    createSpace();

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = fetchQuestions;

    function fetchQuestions() {
        Papa.parse(SHEET_CSV, { 
            download: true, header: true, 
            complete: (res) => { 
                const data = res.data;
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù† Ø£ÙˆÙ„ ØµÙ Ù…ØªÙˆÙØ±
                if(data.length > 0) {
                    document.getElementById('ui-school-name').innerText = data[0]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || "Ù…Ø¯Ø±Ø³Ø© Ø°Ø§Øª Ø§Ù„ØµÙˆØ§Ø±ÙŠ";
                    document.getElementById('ui-manager-name').innerText = data[0]['Ø§Ù„Ù…Ø¯ÙŠØ±'] || "Ø£. Ø³Ù‡ÙŠÙ„ Ø¹Ù‚ÙŠÙ„ÙŠ";
                    document.getElementById('ui-teacher-name').innerText = data[0]['Ø§Ù„Ù…Ø¹Ù„Ù…'] || "Ø£. Ø±ÙŠØ§Ù† Ø§Ù„Ø§Ø³Ù…Ø±ÙŠ";
                }

                allQuestions = data.map(q => ({
                    lab: q['Ø§Ù„Ù…Ø®ØªØ¨Ø±'], question: q['Ø§Ù„Ø³Ø¤Ø§Ù„'],
                    correct: q['Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©'], wrong: q['Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'],
                    image: q['Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©']
                }));
                renderTabs(); 
            } 
        });
    }

    function startApp() {
        studentName = document.getElementById('stdName').value;
        if(!studentName) return alert("ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('tabs-container').style.display = 'block';
    }

    function renderTabs() {
        const labs = [...new Set(allQuestions.filter(q => q.lab).map(q => q.lab))];
        const div = document.getElementById('tabs');
        div.innerHTML = "";
        labs.forEach(lab => { div.innerHTML += `<button class="btn" onclick="runQuiz('${lab}')">${lab}</button>`; });
    }

    function runQuiz(labName) {
        currentLab = labName; score = 0;
        document.getElementById('tabs-container').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';
        
        const qs = allQuestions.filter(q => q.lab === labName);
        let currentQIndex = 0;

        const showQ = (n) => {
            clearInterval(timerInterval);
            if(n >= qs.length) { finish(); return; }
            currentQIndex = n;
            document.getElementById('qCounter').innerText = `${n+1} / ${qs.length}`;
            document.getElementById('qText').innerText = qs[n].question;
            const imgTag = document.getElementById('qImage');
            
            if(qs[n].image && qs[n].image.trim() !== "") {
                let finalImg = qs[n].image.trim();
                if(finalImg.includes('ibb.co') && !finalImg.includes('i.ibb.co')) {
                    finalImg = finalImg.replace('ibb.co', 'i.ibb.co') + '/image.png';
                }
                imgTag.src = finalImg; 
                imgTag.style.display = "block";
            } else {
                imgTag.style.display = "none";
            }
            
            timeLeft = 30; updateTimerUI();
            startTimer(() => showQ(n+1));

            const optDiv = document.getElementById('optionsContainer');
            optDiv.innerHTML = "";
            [qs[n].correct, qs[n].wrong].sort(()=>Math.random()-0.5).forEach(opt => {
                const b = document.createElement('div');
                b.className = 'option'; b.innerText = opt;
                b.onclick = () => {
                    clearInterval(timerInterval);
                    if(opt === qs[n].correct) { b.classList.add('correct'); score += 1; } 
                    else { b.classList.add('wrong'); }
                    setTimeout(()=>showQ(n+1), 800);
                };
                optDiv.appendChild(b);
            });
        };
        showQ(0);
    }

    function startTimer(onTimeout) {
        timerInterval = setInterval(() => {
            timeLeft--; updateTimerUI();
            if (timeLeft <= 0) { clearInterval(timerInterval); onTimeout(); }
        }, 1000);
    }

    function updateTimerUI() {
        document.getElementById('timerText').innerText = timeLeft + "s";
        document.getElementById('timerBar').style.width = (timeLeft / 30) * 100 + "%";
    }

    function backToLabs() {
        clearInterval(timerInterval);
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('tabs-container').style.display = 'block';
    }

    function retryQuiz() { runQuiz(currentLab); }

    function finish() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('finalName').innerText = studentName;
        document.getElementById('finalLab').innerText = "Ù…Ø®ØªØ¨Ø±: " + currentLab;
        document.getElementById('finalScore').innerText = score + " XP";

        const autoForm = document.createElement('form');
        autoForm.method = 'POST';
        autoForm.action = FORM_BASE_URL;
        autoForm.target = 'hidden_iframe';

        const nameInput = document.createElement('input');
        nameInput.name = ENTRY_NAME;
        nameInput.value = studentName;
        autoForm.appendChild(nameInput);

        const scoreInput = document.createElement('input');
        scoreInput.name = ENTRY_SCORE;
        scoreInput.value = score + " ÙÙŠ Ù…Ø®ØªØ¨Ø± " + currentLab;
        autoForm.appendChild(scoreInput);

        document.body.appendChild(autoForm);
        autoForm.submit();
        document.body.removeChild(autoForm);

        document.getElementById('result-screen').style.display = 'block';
    }

    function takeScreenshot() {
        html2canvas(document.getElementById('photo-card')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Ù†ØªÙŠØ¬Ø©_${studentName}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function goToWhatsApp() {
        const teacherName = document.getElementById('ui-teacher-name').innerText;
        const msg = `Ø£Ø³ØªØ§Ø° ${teacherName}ØŒ Ø§Ù„Ø·Ø§Ù„Ø¨ (${studentName}) Ø­Ù‚Ù‚ ${score} ÙÙŠ Ù…Ø®ØªØ¨Ø± (${currentLab})`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    }
</script>
</body>
</html>
